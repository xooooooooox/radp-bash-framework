name: Attach release artifacts

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag_name:
        description: Tag name to attach artifacts to (e.g. v0.1.3). Defaults to the latest release tag when empty.
        required: false
        default: ""

permissions:
  contents: write

jobs:
  attach-artifacts:
    runs-on: ubuntu-latest
    env:
      COPR_LOGIN: ${{ secrets.COPR_LOGIN }}
      COPR_TOKEN: ${{ secrets.COPR_TOKEN }}
      COPR_USERNAME: ${{ secrets.COPR_USERNAME }}
      COPR_PROJECT: ${{ secrets.COPR_PROJECT }}
      OBS_USERNAME: ${{ secrets.OBS_USERNAME }}
      OBS_PASSWORD: ${{ secrets.OBS_PASSWORD }}
      OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
      OBS_PACKAGE: ${{ secrets.OBS_PACKAGE }}
      OBS_API_URL: ${{ secrets.OBS_API_URL }}
      HOMEBREW_FORMULA_URL: https://raw.githubusercontent.com/xooooooooox/homebrew-radp/main/Formula/radp-bash-framework.rb
    steps:
      - name: Resolve tag
        id: tag
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            tag_name="${GITHUB_REF_NAME}"
          else
            tag_name="${{ github.event.inputs.tag_name }}"
          fi
          if [[ -z "${tag_name}" ]]; then
            tag_name="$(gh release list --repo "${repo}" --limit 1 --json tagName --jq '.[0].tagName')"
          fi
          if [[ -z "${tag_name}" ]]; then
            echo "Unable to resolve tag name." >&2
            exit 1
          fi
          echo "tag_name=${tag_name}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.tag.outputs.tag_name }}

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Read and validate version
        id: version
        run: |
          set -euo pipefail
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version=$(sed -n 's/^declare -gr gr_fw_version=//p' "$constants_file" | head -n 1)
          if [[ -z "$version" ]]; then
            echo "Failed to read gr_fw_version from $constants_file" >&2
            exit 1
          fi
          if [[ "${{ steps.tag.outputs.tag_name }}" != "${version}" ]]; then
            echo "Resolved tag (${{ steps.tag.outputs.tag_name }}) does not match gr_fw_version (${version})." >&2
            exit 1
          fi
          version_no_prefix="${version#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "version_no_prefix=${version_no_prefix}" >> "$GITHUB_OUTPUT"

      - name: Prepare directories
        run: mkdir -p artifacts/copr artifacts/obs artifacts/homebrew

      - name: Install copr-cli
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y python3-pip
          python3 -m pip install --upgrade pip copr-cli

      - name: Configure copr-cli
        run: |
          set -euo pipefail
          for value in COPR_LOGIN COPR_TOKEN COPR_USERNAME COPR_PROJECT; do
            if [[ -z "${!value:-}" ]]; then
              echo "Missing required COPR secret: ${value}" >&2
              exit 1
            fi
          done
          mkdir -p ~/.config
          cat <<CONFIG > ~/.config/copr
          [copr-cli]
          login = ${COPR_LOGIN}
          token = ${COPR_TOKEN}
          username = ${COPR_USERNAME}
          copr_url = https://copr.fedorainfracloud.org
          encrypted = false

          [main]
          login = ${COPR_LOGIN}
          token = ${COPR_TOKEN}
          username = ${COPR_USERNAME}
          copr_url = https://copr.fedorainfracloud.org
          encrypted = false
          CONFIG

      - name: Download COPR RPMs
        run: |
          set -euo pipefail
          owner="${COPR_PROJECT%%/*}"
          project="${COPR_PROJECT#*/}"
          version="${{ steps.version.outputs.version_no_prefix }}"
          chroots=$(copr-cli list-chroots "${COPR_PROJECT}")
          base_url="https://download.copr.fedorainfracloud.org/results/${owner}/${project}"
          found=0
          for chroot in $chroots; do
            repo_url="${base_url}/${chroot}"
            if ! html=$(curl -fsSL "${repo_url}/"); then
              echo "Skip ${chroot}: cannot list ${repo_url}/" >&2
              continue
            fi
            rpms=$(printf "%s" "${html}" | grep -o "radp-bash-framework-${version}[^\"']*\\.rpm" | sort -u)
            if [[ -z "${rpms}" ]]; then
              echo "No RPMs found for ${chroot}"
              continue
            fi
            for rpm in $rpms; do
              dest="artifacts/copr/${chroot}-${rpm}"
              if curl -fL --show-error -o "${dest}" "${repo_url}/${rpm}"; then
                echo "Downloaded ${dest}"
                found=$((found+1))
              else
                echo "Failed to download ${repo_url}/${rpm}" >&2
              fi
            done
          done
          if [[ "${found}" -eq 0 ]]; then
            echo "No COPR RPMs downloaded." >&2
          fi

      - name: Install osc
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc
        run: |
          set -euo pipefail
          default_api_url="https://api.opensuse.org"
          api_url="${OBS_API_URL:-$default_api_url}"
          for value in OBS_USERNAME OBS_PASSWORD OBS_PROJECT OBS_PACKAGE; do
            if [[ -z "${!value:-}" ]]; then
              echo "Missing required OBS secret: ${value}" >&2
              exit 1
            fi
          done
          mkdir -p ~/.oscrc
          cat > ~/.oscrc <<EOF
          [general]
          apiurl = ${api_url}

          [${api_url}]
          user = ${OBS_USERNAME}
          pass = ${OBS_PASSWORD}
          EOF
          chmod 600 ~/.oscrc
          echo "OBS_API_URL=${api_url}" >> "$GITHUB_ENV"

      - name: Download OBS binaries
        env:
          OBS_OUT: artifacts/obs
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          import pathlib
          import subprocess
          import urllib.parse
          import urllib.request
          import xml.etree.ElementTree as ET

          proj = os.environ["OBS_PROJECT"]
          pkg = os.environ["OBS_PACKAGE"]
          api = os.environ["OBS_API_URL"]
          out_dir = pathlib.Path(os.environ["OBS_OUT"])
          out_dir.mkdir(parents=True, exist_ok=True)

          def osc_api(path: str) -> str:
              return subprocess.check_output(["osc", "-A", api, "api", path], text=True)

          result_xml = osc_api(f"/build/{proj}/_result?package={pkg}")
          root = ET.fromstring(result_xml)
          targets = []
          for res in root.findall("result"):
              repo = res.get("repository")
              arch = res.get("arch")
              status = res.find("status")
              code = status.get("code") if status is not None else res.get("code")
              if code != "succeeded":
                  continue
              targets.append((repo, arch))

          if not targets:
              print("No succeeded OBS targets found; skipping OBS download.")
              raise SystemExit(0)

          downloaded = 0
          base_dl = "https://download.opensuse.org/repositories"
          for repo, arch in targets:
              listing_xml = osc_api(f"/build/{proj}/{repo}/{arch}/{pkg}")
              lroot = ET.fromstring(listing_xml)
              for entry in lroot.findall("entry"):
                  name = entry.get("name")
                  if not name:
                      continue
                  if name.endswith(".src.rpm") or name.endswith(".log"):
                      continue
                  if not (name.endswith(".rpm") or name.endswith(".deb")):
                      continue
                  url_parts = [
                      base_dl,
                      urllib.parse.quote(proj, safe="/:"),
                      urllib.parse.quote(repo, safe=""),
                      urllib.parse.quote(arch, safe=""),
                      urllib.parse.quote(name, safe=""),
                  ]
                  url = "/".join(url_parts)
                  dest = out_dir / f"{repo}-{arch}-{name}"
                  print(f"Downloading {url} -> {dest}")
                  with urllib.request.urlopen(url) as resp, open(dest, "wb") as f:
                      f.write(resp.read())
                  downloaded += 1

          if downloaded == 0:
              print("No OBS binaries downloaded.")
          PY

      - name: Download Homebrew formula
        run: |
          set -euo pipefail
          curl -fsSL -o artifacts/homebrew/radp-bash-framework.rb "${HOMEBREW_FORMULA_URL}"

      - name: Upload assets to release
        run: |
          set -euo pipefail
          tag_name="${{ steps.tag.outputs.tag_name }}"
          mapfile -t files < <(find artifacts -type f)
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No artifacts found to upload." >&2
            exit 1
          fi
          echo "Uploading assets to release ${tag_name}:"
          printf '  %s\n' "${files[@]}"
          gh release upload "${tag_name}" "${files[@]}" --clobber
        env:
          GH_TOKEN: ${{ github.token }}
