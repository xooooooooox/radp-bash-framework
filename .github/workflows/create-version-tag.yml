name: Create version tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-version-tag:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: version
        run: |
          set -euo pipefail
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version=$(sed -n 's/^declare -gr gr_fw_version=//p' "$constants_file" | head -n 1)
          if [[ -z "$version" ]]; then
            echo "Failed to read gr_fw_version from $constants_file" >&2
            exit 1
          fi
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version '$version' does not match vx.y.z" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Validate changelog
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"
          changelog_file="CHANGELOG.md"
          if [[ ! -f "$changelog_file" ]]; then
            echo "CHANGELOG.md not found; update changelog before tagging." >&2
            exit 1
          fi
          if ! grep -Eq "^##[[:space:]]+v?${version_no_prefix}([[:space:]]|$)" "$changelog_file"; then
            echo "CHANGELOG.md missing entry for ${version}; update changelog before tagging." >&2
            exit 1
          fi

      - name: Sync spec version
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"
          copr_spec_file="packaging/copr/radp-bash-framework.spec"
          if [[ -f "$copr_spec_file" ]]; then
            sed -i "s/^Version:.*/Version:        ${version_no_prefix}/" "$copr_spec_file"
          else
            echo "COPR spec file not found: $copr_spec_file" >&2
            exit 1
          fi
          obs_spec_file="packaging/obs/radp-bash-framework.spec"
          if [[ -f "$obs_spec_file" ]]; then
            sed -i "s/^Version:.*/Version:        ${version_no_prefix}/" "$obs_spec_file"
          else
            echo "OBS spec file not found: $obs_spec_file" >&2
            exit 1
          fi

      - name: Commit spec updates
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No spec updates to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packaging/copr/radp-bash-framework.spec
          if [[ -f "packaging/obs/radp-bash-framework.spec" ]]; then
            git add packaging/obs/radp-bash-framework.spec
          fi
          git commit -m "Sync spec version to ${{ steps.version.outputs.version }}"
          git push

      - name: Create and push tag
        run: |
          version="${{ steps.version.outputs.version }}"
          if git rev-parse "$version" >/dev/null 2>&1; then
            echo "Tag $version already exists."
            exit 0
          fi
          git tag "$version"
          git push origin "$version"
