name: Create version tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-version-tag:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: version
        run: |
          set -euo pipefail
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version=$(sed -n 's/^declare -gr gr_fw_version=//p' "$constants_file" | head -n 1)
          if [[ -z "$version" ]]; then
            echo "Failed to read gr_fw_version from $constants_file" >&2
            exit 1
          fi
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version '$version' does not match vx.y.z" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Validate changelog
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"
          changelog_file="CHANGELOG.md"
          if [[ ! -f "$changelog_file" ]]; then
            echo "CHANGELOG.md not found; update changelog before tagging." >&2
            exit 1
          fi
          if ! grep -Eq "^##[[:space:]]+v?${version_no_prefix}([[:space:]]|$)" "$changelog_file"; then
            echo "CHANGELOG.md missing entry for ${version}; update changelog before tagging." >&2
            exit 1
          fi

      - name: Validate spec versions
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"
          copr_spec_file="packaging/copr/radp-bash-framework.spec"
          obs_spec_file="packaging/obs/radp-bash-framework.spec"
          for spec_file in "$copr_spec_file" "$obs_spec_file"; do
            if [[ ! -f "$spec_file" ]]; then
              echo "Spec file not found: $spec_file" >&2
              exit 1
            fi
            spec_version="$(awk -F'[: ]+' '/^Version:/{print $2; exit}' "$spec_file")"
            if [[ -z "$spec_version" ]]; then
              echo "Failed to read Version from $spec_file" >&2
              exit 1
            fi
            if [[ "$spec_version" != "$version_no_prefix" ]]; then
              echo "Spec version mismatch in $spec_file: expected $version_no_prefix, got $spec_version" >&2
              echo "Run release-prep to sync spec versions before tagging." >&2
              exit 1
            fi
          done

      - name: Create and push tag
        run: |
          version="${{ steps.version.outputs.version }}"
          if git rev-parse "$version" >/dev/null 2>&1; then
            echo "Tag $version already exists."
            exit 0
          fi
          git tag "$version"
          git push origin "$version"
