name: Update spec version

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_run:
    workflows:
      - Create version tag
    types:
      - completed

permissions:
  contents: write

jobs:
  update-spec-version:
    if: >-
      ${{
        github.event_name != 'workflow_run' ||
        (github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main')
      }}
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Read and validate version
        id: version
        run: |
          set -euo pipefail
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version=$(sed -n 's/^declare -gr gr_fw_version=//p' "$constants_file" | head -n 1)
          if [[ -z "$version" ]]; then
            echo "Failed to read gr_fw_version from $constants_file" >&2
            exit 1
          fi
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version '$version' does not match vx.y.z" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Check version change and tag
        id: gate
        run: |
          set -euo pipefail
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version="${{ steps.version.outputs.version }}"
          if ! git rev-parse "$version" >/dev/null 2>&1; then
            echo "Tag $version does not exist. Skipping spec update."
            echo "should_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          if [[ -z "$latest_tag" ]]; then
            echo "No tags found. Skipping spec update."
            echo "should_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          latest_version=$(git show "${latest_tag}:${constants_file}" | sed -n 's/^declare -gr gr_fw_version=//p' | head -n 1)
          if [[ -z "$latest_version" ]]; then
            echo "Failed to read gr_fw_version from tag ${latest_tag}. Skipping spec update." >&2
            echo "should_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ "$latest_version" == "$version" ]]; then
            echo "gr_fw_version matches latest tag (${latest_tag}). Skipping spec update."
            echo "should_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_update=true" >> "$GITHUB_OUTPUT"

      - name: Update spec version
        if: steps.gate.outputs.should_update == 'true'
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          version_no_prefix="${version#v}"
          copr_spec_file="packaging/copr/radp-bash-framework.spec"
          if [[ -f "$copr_spec_file" ]]; then
            sed -i "s/^Version:.*/Version:        ${version_no_prefix}/" "$copr_spec_file"
          else
            echo "COPR spec file not found: $copr_spec_file" >&2
            exit 1
          fi
          obs_spec_file="packaging/obs/radp-bash-framework.spec"
          if [[ -f "$obs_spec_file" ]]; then
            sed -i "s/^Version:.*/Version:        ${version_no_prefix}/" "$obs_spec_file"
          else
            echo "OBS spec file not found: $obs_spec_file" >&2
            exit 1
          fi

      - name: Commit and push
        if: steps.gate.outputs.should_update == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packaging/copr/radp-bash-framework.spec
          if [[ -f "packaging/obs/radp-bash-framework.spec" ]]; then
            git add packaging/obs/radp-bash-framework.spec
          fi
          git commit -m "Update spec version to ${{ steps.version.outputs.version }}"
          git push
