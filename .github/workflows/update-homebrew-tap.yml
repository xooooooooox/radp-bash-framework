name: Update Homebrew Tap

on:
  push:
    tags:
      - "v*"
  workflow_run:
    workflows:
      - Create version tag
    types:
      - completed
  workflow_dispatch:

jobs:
  update-tap:
    if: >-
      ${{
        github.event_name != 'workflow_run' ||
        (github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main')
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TAP_REPO: xooooooooox/homebrew-radp
      TAP_FORMULA_PATH: Formula/radp-bash-framework.rb
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          path: homebrew-radp
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Prepare release metadata
        id: release
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_run" ]]; then
            head_sha="${{ github.event.workflow_run.head_sha }}"
            tag_name="$(git tag --points-at "${head_sha}" --list 'v*' | sort -V | tail -n 1)"
          else
            tag_name="${GITHUB_REF_NAME}"
          fi
          if [[ -z "${tag_name}" ]]; then
            echo "Failed to resolve version tag for event ${GITHUB_EVENT_NAME}" >&2
            exit 1
          fi
          constants_file="src/main/shell/framework/bootstrap/context/vars/constants/constants.sh"
          version_from_tag="$(git show "${tag_name}:${constants_file}" | sed -n 's/^declare -gr gr_fw_version=//p' | head -n 1)"
          if [[ -z "${version_from_tag}" ]]; then
            echo "Failed to read gr_fw_version from ${constants_file} at ${tag_name}" >&2
            exit 1
          fi
          if [[ "${version_from_tag}" != "${tag_name}" ]]; then
            echo "Tag ${tag_name} does not match gr_fw_version (${version_from_tag})" >&2
            exit 1
          fi
          version="${tag_name#v}"
          tarball_url="https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${tag_name}.tar.gz"
          sha256="$(curl -L "${tarball_url}" | sha256sum | awk '{print $1}')"
          echo "tag_name=${tag_name}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tarball_url=${tarball_url}" >> "$GITHUB_OUTPUT"
          echo "sha256=${sha256}" >> "$GITHUB_OUTPUT"

      - name: Update formula
        run: |
          set -euo pipefail
          formula="homebrew-radp/${TAP_FORMULA_PATH}"
          export RELEASE_TAG_NAME="${{ steps.release.outputs.tag_name }}"
          export RELEASE_VERSION="${{ steps.release.outputs.version }}"
          export RELEASE_TARBALL_URL="${{ steps.release.outputs.tarball_url }}"
          export RELEASE_SHA256="${{ steps.release.outputs.sha256 }}"
          python - <<'PY'
          import os
          import pathlib
          import re

          formula_path = pathlib.Path("homebrew-radp") / pathlib.Path(os.environ["TAP_FORMULA_PATH"])
          tag_name = os.environ["RELEASE_TAG_NAME"]
          version = os.environ["RELEASE_VERSION"]
          tarball_url = os.environ["RELEASE_TARBALL_URL"]
          sha256 = os.environ["RELEASE_SHA256"]

          if not formula_path.exists():
            raise SystemExit(f"Formula not found: {formula_path}")

          content = formula_path.read_text(encoding="utf-8")

          content, url_count = re.subn(r'^\s*url\s+"[^"]+"', f'  url "{tarball_url}"', content, flags=re.MULTILINE)
          content, sha_count = re.subn(r'^\s*sha256\s+"[^"]+"', f'  sha256 "{sha256}"', content, flags=re.MULTILINE)
          content, version_count = re.subn(r'^\s*version\s+"[^"]+"', f'  version "{version}"', content, flags=re.MULTILINE)

          if url_count == 0 or sha_count == 0:
            raise SystemExit("Failed to update url/sha256 in formula")

          formula_path.write_text(content, encoding="utf-8")
          print(f"Updated {formula_path} to {tag_name}")
          PY

      - name: Commit and push tap
        run: |
          set -euo pipefail
          cd homebrew-radp
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${TAP_FORMULA_PATH}"
          git commit -m "Update radp-bash-framework to ${{ steps.release.outputs.tag_name }}"
          git push
