#!/usr/bin/env bash
set -euo pipefail

__radp_bf_usage() {
  cat <<'USAGE'
radp-bash-framework
Usage:
  radp-bash-framework [--print-root|--print-run|--help]

Commands:
  --print-root  Print framework root directory (default).
  --print-run   Print full path to run.sh.
  --help        Show this help.

Example:
  source "$(radp-bash-framework --print-run)"
USAGE
}

__radp_bf_bin_dir() {
  local src="${BASH_SOURCE[0]}"

  # 如果是通过相对路径调用, 得到其绝对路径
  if [[ "${src}" != /* ]]; then
    src="$(cd -P -- "$(dirname -- "${src}")" && pwd)/$(basename -- "${src}")"
  fi

  # 解决符号链接, 获取其真实绝对路径
  local dir
  while [[ -L "${src}" ]]; do
    dir="$(cd -P -- "$(dirname -- "${src}")" && pwd)"
    src="$(readlink "${src}")"
    [[ "${src}" != /* ]] && src="${dir}/${src}"
  done

  cd -P -- "$(dirname -- "${src}")" && pwd
}

__radp_bf_setup() {
  local bin_dir
  bin_dir=$(__radp_bf_bin_dir)

  local project_src_root
  project_src_root=$(dirname "$bin_dir")
  # shellcheck source=../framework/run.sh
  source "$project_src_root"/framework/run.sh
}

__radp_bf_main() {
  # 丢弃打印 banner 等信息
  __radp_bf_setup >/dev/null

  case "${1:-}" in
  --help | -h)
    __radp_bf_usage
    return 0
    ;;
  --print-run)
    echo "${gr_fw_root_path}/run.sh"
    return 0
    ;;
  --print-root | "")
    echo "${gr_fw_root_path}"
    return 0
    ;;
  *)
    echo "radp-bash-framework: unknown argument '${1}'" >&2
    __radp_bf_usage >&2
    return 2
    ;;
  esac
}

__radp_bf_main "$@"
